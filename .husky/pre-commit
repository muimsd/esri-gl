#!/usr/bin/env sh

. "$(dirname -- "$0")/_/husky.sh"

YELLOW='\033[1;33m'
GREEN='\033[0;32m'
RED='\033[0;31m'
RESET='\033[0m'

run_step() {
	cmd="$1"
	label="$2"
	guidance="$3"

	printf "\n${YELLOW}▶ %s…${RESET}\n" "$label"

	if sh -c "$cmd"; then
		printf "${GREEN}✔ %s passed${RESET}\n" "$label"
		return 0
	else
		status=$?
		printf "${RED}✖ %s failed (exit code %s)${RESET}\n" "$label" "$status"
		if [ -n "$guidance" ]; then
			printf "${RED}%s${RESET}\n" "$guidance"
		fi
		printf "${RED}Commit aborted. Fix the issues above and try again.${RESET}\n"
		exit $status
	fi
}

run_step "npx lint-staged" \
	"Lint-staged format & quick fixes" \
	"Run 'npm run format:check' to check formatting locally."

run_step "npm run lint" \
	"ESLint" \
	"Run 'npm run lint' to inspect lint errors locally."

run_step "npm run test -- --bail --watchAll=false" \
	"Jest unit tests" \
	"Run 'npm run test' to reproduce the failing tests."
