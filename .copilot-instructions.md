# Copilot Instructions for Esri Map GL

## Project Overview

This is a MapLibre GL JS / Mapbox GL JS library that replicates Esri Leaflet functionality for web mapping. The library provides MapLibre/Mapbox GL compatible services for consuming ArcGIS REST services including Dynamic Map Services, Tiled Map Services, Image Services, Vector Tile Services, and Feature Services.

## Key Architecture

The library follows the Esri Leaflet architecture pattern with Services, Tasks, and Layers:

### Services
- `DynamicMapService` - For ArcGIS Dynamic Map Services (raster tiles)
- `TiledMapService` - For ArcGIS Tiled Map Services (cached tiles) 
- `ImageService` - For ArcGIS Image Services
- `VectorTileService` - For ArcGIS Vector Tile Services
- `VectorBasemapStyle` - For Esri Vector Basemap Styles
- `FeatureService` - For ArcGIS Feature Services

### Tasks  
- `IdentifyFeatures` - Identify features at a point
- `Query` - Query features with SQL-like syntax
- `Find` - Find features by text search
- `IdentifyImage` - Identify pixels in image services

### Current Working API Patterns

Based on the working demo components in `src/demo/components/`, the API follows these patterns:

#### DynamicMapService Usage:
```typescript
import { DynamicMapService } from 'esri-map-gl'

// Create service
const service = new DynamicMapService(sourceId, map, {
  url: 'https://server/arcgis/rest/services/MapServer',
  layers: [0, 1, 2], // which layers to show
  format: 'png32',
  transparent: true
})

// Add to map
map.addLayer({
  id: 'dynamic-layer',
  type: 'raster', 
  source: sourceId
})

// Identify features (direct method)
const results = await service.identify({
  lng: -95.7129,
  lat: 37.0902  
}, true) // returnGeometry

// Update layers
service.setLayers([1, 2, 3])
```

#### IdentifyFeatures Task Usage:
```typescript
import { IdentifyFeatures } from 'esri-map-gl'

// Create identify service
const identifyService = new IdentifyFeatures({
  url: 'https://server/arcgis/rest/services/MapServer',
  tolerance: 5,
  returnGeometry: true,
  layers: 'all'
})

// Identify at location
const results = await identifyService.at({
  lng: -95.7129,
  lat: 37.0902
}, map)

// Update options
identifyService.setTolerance(10)
identifyService.setLayers([0, 1, 2])
```

## File Structure

```
src/
  Services/           # Service classes (DynamicMapService, etc.)
  Tasks/             # Task classes (IdentifyFeatures, Query, etc.)  
  Layers/            # Layer classes (future)
  demo/
    components/      # Working React/TypeScript demo components
  examples/          # Example implementations
  types.ts          # TypeScript type definitions
  utils.ts          # Utility functions
  main.ts           # Main export file
```

## Development Guidelines

1. **Use Working Demos as Reference**: The `src/demo/components/` folder contains working React/TypeScript demonstrations of the actual API. Always reference these when implementing or fixing functionality.

2. **Follow Esri Leaflet Patterns**: The library should match Esri Leaflet's API as closely as possible while being compatible with MapLibre GL JS / Mapbox GL JS.

3. **TypeScript Support**: All code should be properly typed with TypeScript interfaces and types defined in `types.ts`.

4. **Testing**: Use the demo components to test functionality. The demos import from `../../../dist/esri-map-gl.esm.js` which is the built version.

5. **Build Process**: The library is built with Rollup. Run `npm run build` to create the distribution files.

## Key Implementation Notes

- Services create MapLibre/Mapbox sources and manage their updates
- Tasks handle operations like identify, query, and find
- The `identify()` method on DynamicMapService returns results directly
- IdentifyFeatures task uses chainable methods and `.at()` for location
- Both callback and Promise patterns are supported for Esri Leaflet compatibility
- Path aliases use `@/` prefix (e.g., `@/Services/Service`)

## Current API Differences

The working demos show that:
1. `DynamicMapService.identify()` returns results directly (not a Task)
2. `IdentifyFeatures` is a separate task class with chainable methods
3. Both patterns work but serve different use cases

## Working Example URLs

The demos commonly use these test servers:
- `https://sampleserver6.arcgisonline.com/arcgis/rest/services/USA/MapServer`
- `https://sampleserver6.arcgisonline.com/arcgis/rest/services/WorldTimeZones/MapServer`

Always refer to the working demo components when implementing new features or fixing issues.
